#!/usr/bin/env bash

#
# Ubuntu 24.04 Nginx 高性能反向代理一键部署脚本 (终极交互版)
#
# 特性:
#   1. 适配 Nginx 1.25+ (http2 on 语法)
#   2. 自动解决源站 SNI 握手问题 (proxy_ssl_server_name)
#   3. 强制从 /dev/tty 读取输入，兼容各种运行方式
#   4. 独立的缓存与日志路径，权限自动修复
#

set -eo pipefail

# --- 交互式输入函数 ---
get_user_input() {
    echo "========================================================"
    echo "   🌐 Nginx 高性能反向代理一键配置 (终极版)"
    echo "========================================================"
    
    # 获取反代域名
    while [[ -z "$PROXY_DOMAIN" ]]; do
        read -p "1. 请输入【反代域名】 (如: xxx.xxx.xxx): " PROXY_DOMAIN < /dev/tty
    done

    # 获取源站域名
    while [[ -z "$ORIGIN_DOMAIN" ]]; do
        read -p "2. 请输入【源站域名】 (如: xxx.xxx.xxx): " ORIGIN_DOMAIN < /dev/tty
    done

    # 获取邮箱
    while [[ ! "$EMAIL" =~ ^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,4}$ ]]; do
        read -p "3. 请输入【联系邮箱】 (用于SSL通知): " EMAIL < /dev/tty
    done

    # 路径动态定义
    NGINX_CONF_FILE="/etc/nginx/sites-available/$PROXY_DOMAIN.conf"
    CACHE_DIR="/var/cache/nginx/$PROXY_DOMAIN"
    LOG_DIR="/var/log/nginx/$PROXY_DOMAIN"
    CACHE_ZONE_NAME="${PROXY_DOMAIN//./_}_cache"
}

main() {
    # 1. 检查权限
    if [ "$(id -u)" -ne 0 ]; then
        echo "❌ 错误：此脚本必须以 root 权限运行 (请使用 sudo)。"
        exit 1
    fi

    clear
    get_user_input

    echo -e "\n--------------------------------------------------------"
    echo "🚀 准备部署..."
    echo "   - 反代域名: $PROXY_DOMAIN"
    echo "   - 源站域名: $ORIGIN_DOMAIN"
    echo "   - 联系邮箱: $EMAIL"
    echo "--------------------------------------------------------"
    read -p "确认无误请按回车继续，或 Ctrl+C 退出..." < /dev/tty

    # 执行流程
    prepare_system
    request_ssl
    write_config
    setup_firewall
    show_done
}

# --- 详细步骤实现 ---

prepare_system() {
    echo "--> 步骤 1: 准备环境与安装依赖..."
    apt-get update > /dev/null
    apt-get install -y nginx python3-certbot-nginx
    
    mkdir -p "$CACHE_DIR" "$LOG_DIR"
    chown -R www-data:www-data "$CACHE_DIR" "$LOG_DIR"
}

request_ssl() {
    echo "--> 步骤 2: 申请 SSL 证书..."
    
    # 预创建临时配置
    if [ ! -f "$NGINX_CONF_FILE" ]; then
        echo "server { listen 80; server_name $PROXY_DOMAIN; }" > "$NGINX_CONF_FILE"
        ln -s -f "$NGINX_CONF_FILE" "/etc/nginx/sites-enabled/"
    fi
    systemctl reload nginx || systemctl start nginx

    certbot --nginx --agree-tos --non-interactive --keep-until-expiring \
        --no-eff-email --email "$EMAIL" -d "$PROXY_DOMAIN" --redirect

    if [ $? -ne 0 ]; then
        echo "❌ SSL 申请失败！请检查域名解析是否生效。"
        exit 1
    fi
}

write_config() {
    echo "--> 步骤 3: 写入优化版 Nginx 配置..."

    cat > "$NGINX_CONF_FILE" <<EOF
# 独立缓存区域
proxy_cache_path ${CACHE_DIR} levels=1:2 keys_zone=${CACHE_ZONE_NAME}:10m max_size=1g inactive=60m use_temp_path=off;

server {
    listen 80;
    server_name ${PROXY_DOMAIN};
    return 301 https://\$host\$request_uri;
}

server {
    listen 443 ssl;
    http2 on; # Nginx 1.25+ 语法
    server_name ${PROXY_DOMAIN};

    # 日志记录
    access_log ${LOG_DIR}/access.log;
    error_log  ${LOG_DIR}/error.log warn;

    # Certbot 证书路径
    ssl_certificate /etc/letsencrypt/live/${PROXY_DOMAIN}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/${PROXY_DOMAIN}/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # SSL 增强
    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.8.8 1.1.1.1 valid=300s;

    # 基础安全头
    add_header Strict-Transport-Security "max-age=31536000" always;
    add_header X-Frame-Options "SAMEORIGIN" always;

    location / {
        # --- 反向代理 ---
        proxy_pass https://${ORIGIN_DOMAIN};
        
        # --- SNI 修复 (防止502的关键) ---
        proxy_ssl_server_name on;
        proxy_ssl_name ${ORIGIN_DOMAIN};
        proxy_ssl_session_reuse on;

        # --- Headers 传递 ---
        proxy_set_header Host ${ORIGIN_DOMAIN};
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;

        # --- WebSocket 支持 ---
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";

        # --- 缓存设置 ---
        proxy_cache ${CACHE_ZONE_NAME};
        proxy_cache_valid 200 302 15m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        add_header X-Cache-Status \$upstream_cache_status;
    }
}
EOF

    nginx -t && systemctl reload nginx
}

setup_firewall() {
    if command -v ufw &> /dev/null && ufw status | grep -q "Status: active"; then
        echo "--> 步骤 4: 更新防火墙策略..."
        ufw allow 'Nginx Full'
    fi
}

show_done() {
    echo -e "\n========================================================"
    echo "🎉 恭喜！反向代理已成功部署。"
    echo "========================================================"
    echo "🔗 访问地址: https://${PROXY_DOMAIN}"
    echo "📝 配置文件: ${NGINX_CONF_FILE}"
    echo "📂 日志目录: ${LOG_DIR}"
    echo "--------------------------------------------------------"
}

# 启动主函数
main
