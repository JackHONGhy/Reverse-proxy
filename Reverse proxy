#!/usr/bin/env bash

#
# Ubuntu 24.04 Nginx 高性能反向代理一键部署脚本 (含清理优化)
#
# 更新说明:
#   - 新增: 自动清理 Nginx 默认无用配置 (default site)
#   - 新增: 自动执行 apt 垃圾清理
#   - 修复: 强制读取 /dev/tty 解决交互失效问题
#

set -eo pipefail

# --- 交互式输入函数 ---
get_user_input() {
    echo "========================================================"
    echo "   🌐 Nginx 高性能反向代理一键配置 (含清理功能)"
    echo "========================================================"
    
    while [[ -z "$PROXY_DOMAIN" ]]; do
        read -p "1. 请输入【反代域名】 (如: xxx.xxx.xxx): " PROXY_DOMAIN < /dev/tty
    done

    while [[ -z "$ORIGIN_DOMAIN" ]]; do
        read -p "2. 请输入【源站域名】 (如: xxx.xxx.xxx): " ORIGIN_DOMAIN < /dev/tty
    done

    while [[ ! "$EMAIL" =~ ^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,4}$ ]]; do
        read -p "3. 请输入【联系邮箱】 (用于SSL通知): " EMAIL < /dev/tty
    done

    # 询问是否执行深度清理
    read -p "4. 是否清理系统垃圾与 Nginx 默认配置？(y/n): " DO_CLEANUP < /dev/tty

    # 路径动态定义
    NGINX_CONF_FILE="/etc/nginx/sites-available/$PROXY_DOMAIN.conf"
    CACHE_DIR="/var/cache/nginx/$PROXY_DOMAIN"
    LOG_DIR="/var/log/nginx/$PROXY_DOMAIN"
    CACHE_ZONE_NAME="${PROXY_DOMAIN//./_}_cache"
}

main() {
    if [ "$(id -u)" -ne 0 ]; then
        echo "❌ 错误：请使用 sudo 运行此脚本。"
        exit 1
    fi

    clear
    get_user_input

    echo -e "\n--------------------------------------------------------"
    echo "🚀 部署详情:"
    echo "   - 域名: $PROXY_DOMAIN -> $ORIGIN_DOMAIN"
    echo "   - 深度清理: ${DO_CLEANUP:-n}"
    echo "--------------------------------------------------------"
    read -p "确认无误请按回车继续..." < /dev/tty

    prepare_system
    [[ "$DO_CLEANUP" == "y" ]] && cleanup_and_optimize
    request_ssl
    write_config
    setup_firewall
    show_done
}

# --- 核心步骤 ---

prepare_system() {
    echo "--> 步骤 1: 安装依赖并创建目录..."
    apt-get update > /dev/null
    apt-get install -y nginx python3-certbot-nginx
    
    mkdir -p "$CACHE_DIR" "$LOG_DIR"
    chown -R www-data:www-data "$CACHE_DIR" "$LOG_DIR"
}

cleanup_and_optimize() {
    echo "--> 步骤 2: 正在清理系统垃圾与默认配置..."
    
    # 1. 移除 Nginx 默认站点 (垃圾文件)
    rm -f /etc/nginx/sites-enabled/default
    rm -f /etc/nginx/sites-available/default
    
    # 2. 清理 apt 缓存垃圾
    apt-get autoremove -y > /dev/null
    apt-get clean > /dev/null
    
    # 3. 如果已有旧缓存，则排空
    if [ -d "$CACHE_DIR" ]; then
        find "$CACHE_DIR" -type f -delete
        echo "✅ 旧缓存已清空"
    fi
}

request_ssl() {
    echo "--> 步骤 3: 申请 SSL 证书..."
    if [ ! -f "$NGINX_CONF_FILE" ]; then
        echo "server { listen 80; server_name $PROXY_DOMAIN; }" > "$NGINX_CONF_FILE"
        ln -s -f "$NGINX_CONF_FILE" "/etc/nginx/sites-enabled/"
    fi
    systemctl reload nginx || systemctl start nginx

    certbot --nginx --agree-tos --non-interactive --keep-until-expiring \
        --no-eff-email --email "$EMAIL" -d "$PROXY_DOMAIN" --redirect

    if [ $? -ne 0 ]; then
        echo "❌ SSL 申请失败！"
        exit 1
    fi
}

write_config() {
    echo "--> 步骤 4: 写入高性能配置..."
    cat > "$NGINX_CONF_FILE" <<EOF
proxy_cache_path ${CACHE_DIR} levels=1:2 keys_zone=${CACHE_ZONE_NAME}:10m max_size=1g inactive=60m use_temp_path=off;

server {
    listen 80;
    server_name ${PROXY_DOMAIN};
    return 301 https://\$host\$request_uri;
}

server {
    listen 443 ssl;
    http2 on;
    server_name ${PROXY_DOMAIN};

    access_log ${LOG_DIR}/access.log;
    error_log  ${LOG_DIR}/error.log warn;

    ssl_certificate /etc/letsencrypt/live/${PROXY_DOMAIN}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/${PROXY_DOMAIN}/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.8.8 1.1.1.1 valid=300s;

    location / {
        proxy_pass https://${ORIGIN_DOMAIN};
        proxy_ssl_server_name on;
        proxy_ssl_name ${ORIGIN_DOMAIN};
        proxy_set_header Host ${ORIGIN_DOMAIN};
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;

        # WebSocket
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";

        # Cache
        proxy_cache ${CACHE_ZONE_NAME};
        proxy_cache_valid 200 302 15m;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        add_header X-Cache-Status \$upstream_cache_status;
        add_header Strict-Transport-Security "max-age=31536000" always;
    }
}
EOF
    nginx -t && systemctl reload nginx
}

setup_firewall() {
    if command -v ufw &> /dev/null && ufw status | grep -q "Status: active"; then
        ufw allow 'Nginx Full' > /dev/null
    fi
}

show_done() {
    echo -e "\n========================================================"
    echo "🎉 部署完成！"
    echo "🌍 访问: https://${PROXY_DOMAIN}"
    echo "🗑️ 如果需要手动清理缓存，请运行: rm -rf ${CACHE_DIR}/*"
    echo "========================================================"
}

main
